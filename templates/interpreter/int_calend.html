{% extends 'intbase.html' %}

{% block title %}Schedule -  DBD I&T{% endblock %}

{% block content %}
    <!-- Calendar Navigation -->
    <div class="calendar-header card">
        <div class="card-content d-flex justify-content-between align-items-center">
            <button class="btn btn-icon" id="prevMonth">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 class="current-month">{{ current_month|date:"F Y" }}</h2>
            <button class="btn btn-icon" id="nextMonth">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-container card mt-4">
        <div class="weekdays-grid">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>
        <div class="days-grid" id="calendarDays">
            <!-- Days will be generated by JavaScript -->
        </div>
    </div>

    <!-- Upcoming Missions -->
    <div class="card mt-4">
        <div class="card-header">
            <h3>Upcoming Missions</h3>
        </div>
        <div class="card-content">
            {% if upcoming_missions %}
                {% for mission in upcoming_missions %}
                <div class="mission-item upcoming-mission">
                    <div class="mission-header">
                        <div class="mission-date">
                            <i class="fas fa-calendar"></i>
                            <span>{{ mission.start_time|date:"l, F j, Y" }}</span>
                        </div>
                        <div class="mission-time">
                            {{ mission.start_time|date:"g:i A" }} - {{ mission.end_time|date:"g:i A" }}
                        </div>
                    </div>
                    <div class="mission-info">
                        <div class="mission-client">
                            <i class="fas fa-user"></i>
                            <span>{{ mission.client_info.name }}</span>
                            <div class="client-contact">
                                {% if mission.client_info.phone %}
                                <span class="phone">
                                    <i class="fas fa-phone"></i> {{ mission.client_info.phone }}
                                </span>
                                {% endif %}
                                {% if mission.client_info.email %}
                                <span class="email">
                                    <i class="fas fa-envelope"></i> {{ mission.client_info.email }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mission-details">
                            <div class="mission-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ mission.location.full_address }}</span>
                            </div>
                            <div class="mission-language">
                                <i class="fas fa-language"></i>
                                <span>{{ mission.languages.source }} - {{ mission.languages.target }}</span>
                            </div>
                        </div>
                        <div class="mission-actions">
                            <div class="mission-status {{ mission.status|lower }}">
                                {{ mission.get_status_display }}
                            </div>
                            {% if mission.can_be_started %}
                            <button class="btn btn-success btn-sm start-mission" data-mission-id="{{ mission.id }}">
                                Start Mission
                            </button>
                            {% endif %}
                            {% if mission.can_be_cancelled %}
                            <button class="btn btn-danger btn-sm cancel-mission" data-mission-id="{{ mission.id }}">
                                Cancel
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-missions">
                    <p>No upcoming missions scheduled.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Day's Missions -->
<!-- Day's Missions -->
<div class="card mt-4">
    <div class="card-header">
        <h3 class="selected-date">Missions for Today ({{ today|date:"F j, Y" }})</h3>
    </div>
    <div class="card-content" id="dayMissions">
        {% if todays_assignments.missions %}
            {% for mission in todays_assignments.missions %}
            <div class="mission-item">
                <div class="mission-time">{{ mission.start_time|date:"g:i A" }} - {{ mission.end_time|date:"g:i A" }}</div>
                <div class="mission-info">
                    <div class="mission-client">
                        <i class="fas fa-user"></i>
                        <span>{{ mission.client_info.name }}</span>
                    </div>
                    <div class="mission-phone">
                        <i class="fas fa-phone"></i>
                        <span>{{ mission.client_info.phone }}</span>
                    </div>
                    <div class="mission-email">
                        <i class="fas fa-envelope"></i>
                        <span>{{ mission.client_info.email }}</span>
                    </div>
                    <div class="mission-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ mission.location.full_address }}</span>
                    </div>
                    <div class="mission-language">
                        <i class="fas fa-language"></i>
                        <span>{{ mission.languages.source }} - {{ mission.languages.target }}</span>
                    </div>
                    <div class="mission-status {{ mission.status|lower }}">
                        {{ mission.status }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-missions">
                <p>No missions scheduled for today.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block extra_css %}
<style>
    /* Calendar Base Styles */
    .calendar-header {
        background: rgba(255, 255, 255, 0.1);
    }

    .current-month {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--white);
    }

    .btn-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
    }

    .btn-icon:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Calendar Grid Styles */
    .weekdays-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem;
        text-align: center;
        font-weight: 500;
    }

    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: rgba(255, 255, 255, 0.1);
    }

    .calendar-day {
        aspect-ratio: 1;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }

    .calendar-day:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .calendar-day.today {
        background: rgba(var(--primary-green-rgb), 0.2);
    }

    .calendar-day.selected {
        background: rgba(var(--primary-green-rgb), 0.3);
    }

    .calendar-day.has-missions::after {
        content: '';
        position: absolute;
        bottom: 0.5rem;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--primary-green);
    }

    .day-number {
        font-size: 0.9rem;
    }

    .other-month {
        opacity: 0.5;
    }

    /* Mission Styles */
    .upcoming-mission {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .mission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .mission-date {
        font-weight: 500;
        color: var(--primary-green);
    }

    .mission-item {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: background-color 0.3s;
    }

    .mission-item:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .mission-item:last-child {
        border-bottom: none;
    }

    .mission-time {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--primary-green);
        margin-bottom: 0.5rem;
    }

    .mission-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .mission-info > div {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .client-contact {
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .mission-details {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
    }

    .mission-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    /* Status Styles */
    .mission-status {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
        width: fit-content;
    }

    .mission-status.pending {
        background: var(--warning);
    }

    .mission-status.confirmed {
        background: var(--info);
    }

    .mission-status.in_progress {
        background: var(--primary);
    }

    .mission-status.completed {
        background: var(--success);
    }

    .mission-status.cancelled {
        background: var(--danger);
    }

    .mission-status.no_show {
        background: var(--gray-700);
    }

    /* Action Buttons */
    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        transition: all 0.3s;
    }

    .btn-success {
        background: var(--success);
        border: none;
    }

    .btn-danger {
        background: var(--danger);
        border: none;
    }

    .btn-success:hover {
        background: var(--success-dark);
    }

    .btn-danger:hover {
        background: var(--danger-dark);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .mission-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .mission-info {
            grid-template-columns: 1fr;
        }
        
        .mission-actions {
            justify-content: flex-start;
        }

        .client-contact {
            margin-left: 1.5rem;
        }
    }

    /* Loading States */
    .loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentDate = new Date();
let selectedDate = new Date();

async function generateCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startingDay = firstDay.getDay() || 7; // Convert Sunday (0) to 7
    const totalDays = lastDay.getDate();
    
    // Fetch calendar data
    const calendarData = await fetchCalendarData(year, month);
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';

    // Previous month days
    const prevMonthDays = startingDay - 1;
    const prevMonth = new Date(year, month - 1, 0);
    for (let i = prevMonthDays; i > 0; i--) {
        const dayElement = createDayElement(prevMonth.getDate() - i + 1, true, year, month - 1);
        calendarDays.appendChild(dayElement);
    }

    // Current month days
    for (let day = 1; day <= totalDays; day++) {
        const dayElement = createDayElement(day, false, year, month);
        const dateStr = formatDateString(year, month, day);
        
        if (calendarData && calendarData.dates && calendarData.dates[dateStr]?.has_missions) {
            dayElement.classList.add('has-missions');
            // Ajouter le nombre de missions en tooltip
            const missionCount = calendarData.dates[dateStr].mission_count;
            dayElement.setAttribute('title', `${missionCount} mission${missionCount > 1 ? 's' : ''}`);
        }
        
        if (year === currentDate.getFullYear() && 
            month === currentDate.getMonth() && 
            day === currentDate.getDate()) {
            dayElement.classList.add('today');
        }
        
        if (year === selectedDate.getFullYear() && 
            month === selectedDate.getMonth() && 
            day === selectedDate.getDate()) {
            dayElement.classList.add('selected');
        }
        
        calendarDays.appendChild(dayElement);
    }

    // Next month days
    const remainingDays = 42 - (prevMonthDays + totalDays);
    for (let day = 1; day <= remainingDays; day++) {
        const dayElement = createDayElement(day, true, year, month + 1);
        calendarDays.appendChild(dayElement);
    }

    document.querySelector('.current-month').textContent = 
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

function createDayElement(day, isOtherMonth, year, month) {
    const dayElement = document.createElement('div');
    dayElement.className = `calendar-day${isOtherMonth ? ' other-month' : ''}`;
    dayElement.innerHTML = `<span class="day-number">${day}</span>`;
    dayElement.dataset.date = formatDateString(year, month, day);
    
    dayElement.addEventListener('click', () => selectDate(day, isOtherMonth, year, month));
    return dayElement;
}

async function selectDate(day, isOtherMonth, year, month) {
    document.querySelector('.calendar-day.selected')?.classList.remove('selected');
    event.currentTarget.classList.add('selected');

    if (isOtherMonth) {
        if (day > 20) {
            month--;
        } else {
            month++;
        }
        await generateCalendar(year, month);
    }

    selectedDate = new Date(year, month, day);
    document.getElementById('selectedDate').textContent = 
        selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    
    await updateMissions(selectedDate);
}

async function updateMissions(date) {
    const missionsContainer = document.getElementById('dayMissions');
    missionsContainer.classList.add('loading');
    
    try {
        const formattedDate = formatDateString(date.getFullYear(), date.getMonth(), date.getDate());
        const response = await fetch(`/api/interpreter/missions/${formattedDate}/`);
        
        if (!response.ok) throw new Error('Failed to fetch missions');
        
        const data = await response.json();
        renderMissions(data.missions);
    } catch (error) {
        console.error('Error fetching missions:', error);
        missionsContainer.innerHTML = `
            <div class="error-message">
                <p>Failed to load missions. Please try again.</p>
            </div>
        `;
    } finally {
        missionsContainer.classList.remove('loading');
    }
}

function renderMissions(missions) {
    const missionsContainer = document.getElementById('dayMissions');
    
    if (!missions || missions.length === 0) {
        missionsContainer.innerHTML = `
            <div class="no-missions">
                <p>No missions scheduled for this date.</p>
            </div>
        `;
        return;
    }

    missionsContainer.innerHTML = missions.map(mission => `
        <div class="mission-item">
            <div class="mission-time">${formatTime(mission.start_time)} - ${formatTime(mission.end_time)}</div>
            <div class="mission-info">
                <div class="mission-client">
                    <i class="fas fa-user"></i>
                    <span>${mission.client_info.name}</span>
                </div>
                ${mission.client_info.phone ? `
                    <div class="mission-phone">
                        <i class="fas fa-phone"></i>
                        <span>${mission.client_info.phone}</span>
                    </div>
                ` : ''}
                ${mission.client_info.email ? `
                    <div class="mission-email">
                        <i class="fas fa-envelope"></i>
                        <span>${mission.client_info.email}</span>
                    </div>
                ` : ''}
                <div class="mission-location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${mission.location.full_address}</span>
                </div>
                <div class="mission-language">
                    <i class="fas fa-language"></i>
                    <span>${mission.languages.source} - ${mission.languages.target}</span>
                </div>
                <div class="mission-status ${mission.status.toLowerCase()}">
                    ${mission.status}
                </div>
            </div>
            ${renderMissionActions(mission)}
        </div>
    `).join('');
}

function renderMissionActions(mission) {
    let actions = '';
    
    if (mission.can_be_started) {
        actions += `
            <button class="btn btn-success btn-sm start-mission" data-mission-id="${mission.id}">
                Start Mission
            </button>
        `;
    }
    
    if (mission.can_be_cancelled) {
        actions += `
            <button class="btn btn-danger btn-sm cancel-mission" data-mission-id="${mission.id}">
                Cancel
            </button>
        `;
    }
    
    return actions ? `<div class="mission-actions">${actions}</div>` : '';
}

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
    });
}

async function fetchCalendarData(year, month) {
    try {
        const response = await fetch(`/api/interpreter/calendar-data/${year}/${month + 1}/`);
        return await response.json();
    } catch (error) {
        console.error('Error fetching calendar data:', error);
        return null;
    }
}

function formatDateString(year, month, day) {
    return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
}

// Initialize calendar and event listeners
document.addEventListener('DOMContentLoaded', () => {
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    updateMissions(currentDate);

    // Month navigation
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    // Mission action handlers
    document.addEventListener('click', async function(e) {
        if (e.target.matches('.start-mission')) {
            handleMissionAction(e.target, 'start');
        } else if (e.target.matches('.cancel-mission')) {
            handleMissionAction(e.target, 'cancel');
        }
    });
});

async function handleMissionAction(button, action) {
    const missionId = button.dataset.missionId;
    const originalText = button.textContent;
    
    try {
        button.innerHTML = '<span class="loading-spinner"></span>';
        button.disabled = true;

        const response = await fetch(`/api/interpreter/missions/${missionId}/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error(`Failed to ${action} mission`);

        // Reload the current view
        await updateMissions(selectedDate);
        await generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        
    } catch (error) {
        console.error(`Error ${action}ing mission:`, error);
        alert(`Failed to ${action} mission. Please try again.`);
        button.textContent = originalText;
    } finally {
        button.disabled = false;
    }
}
</script>
{% endblock %}